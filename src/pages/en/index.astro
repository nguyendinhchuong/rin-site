---
import Layout from '@/layouts/Layout.astro';
import ProductCard from '@/components/ProductCard';
import BlogCard from '@/components/BlogCard';
import CategoryCard from '@/components/CategoryCard';
import { sanityClient, urlFor } from '@/lib/sanity';
import { heroBannersQuery, allProductsQuery, recentPostsQuery, siteSettingsQuery, categoriesQuery } from '@/lib/queries';
import { generateOrganizationSchema, generateWebSiteSchema } from '@/lib/seo';

export const prerender = false;

const locale = 'en';

const [heroBanners, products, recentPosts, siteSettings, categories] = await Promise.all([
  sanityClient.fetch(heroBannersQuery, { language: locale }),
  sanityClient.fetch(allProductsQuery, { language: locale }),
  sanityClient.fetch(recentPostsQuery, { language: locale, limit: 3 }),
  sanityClient.fetch(siteSettingsQuery, { language: locale }),
  sanityClient.fetch(categoriesQuery, { language: locale }),
]);

const siteUrl = Astro.site?.toString() || 'https://vinhson.com.vn';

const schema = {
  '@graph': [
    generateOrganizationSchema(
      siteSettings?.siteName || 'Vinh Son',
      siteUrl,
      siteSettings?.logo ? urlFor(siteSettings.logo).url() : undefined,
      siteSettings?.socialMedia
    ),
    generateWebSiteSchema(
      siteSettings?.siteName || 'Vinh Son',
      siteUrl,
      `${siteUrl}/en/search`
    ),
  ],
};
---

<Layout
  title={siteSettings?.seo?.metaTitle || siteSettings?.siteName || 'Vinh Son'}
  description={siteSettings?.seo?.metaDescription || siteSettings?.siteDescription}
  image={siteSettings?.seo?.ogImage ? urlFor(siteSettings.seo.ogImage).url() : undefined}
  schema={schema}
>
  <!-- Hero Banner -->
  {heroBanners && heroBanners.length > 0 && (
    <div class="relative h-[500px] w-full overflow-hidden md:h-[600px]">
      {/* Fallback gradient background */}
      <div class="absolute inset-0 bg-gradient-to-br from-blue-600 via-purple-600 to-indigo-800" />
      
      {/* Background Image from Sanity */}
      {heroBanners[0]?.backgroundImage && (
        <img
          src={urlFor(heroBanners[0].backgroundImage).width(1920).height(600).url()}
          alt={heroBanners[0].backgroundImage.alt || heroBanners[0].title}
          class="absolute inset-0 h-full w-full object-cover"
          loading="eager"
        />
      )}
      
      {/* Dark overlay for better text readability */}
      <div class="absolute inset-0 bg-black/40" />
      
      {/* Content */}
      <div class="absolute inset-0 flex items-center justify-center">
        <div class="container mx-auto px-4 text-center text-white">
          <h1 class="mb-4 text-4xl font-bold md:text-6xl">{heroBanners[0]?.title}</h1>
          {heroBanners[0]?.subtitle && (
            <p class="mb-8 text-lg md:text-xl">{heroBanners[0].subtitle}</p>
          )}
          {heroBanners[0]?.ctaText && heroBanners[0]?.ctaLink && (
            <a
              href={heroBanners[0].ctaLink}
              class="inline-flex h-10 items-center justify-center rounded-md bg-primary px-8 py-2 text-sm font-medium text-primary-foreground ring-offset-background transition-colors hover:bg-primary/90 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2"
            >
              {heroBanners[0].ctaText}
            </a>
          )}
        </div>
      </div>
    </div>
  )}

  <!-- Category List Section -->
  {categories && categories.length > 0 && (
    <section class="container mx-auto px-4 py-20">
      <div class="mb-16 text-center">
        <h2 class="mb-4 text-4xl font-bold tracking-tight md:text-5xl">
          {siteSettings?.categorySection?.title || 'Product Categories'}
        </h2>
        <p class="mx-auto max-w-2xl text-lg text-muted-foreground">
          {siteSettings?.categorySection?.description || 'Explore our diverse range of product categories'}
        </p>
      </div>
      <div class="flex flex-wrap justify-center gap-8 max-w-7xl mx-auto">
        {categories.map((category: any) => (
          <div class="w-80">
            <CategoryCard client:load category={category} locale={locale} />
          </div>
        ))}
      </div>
    </section>
  )}

  <!-- Featured Products Section -->
  {products && products.length > 0 && (
    <section class="container mx-auto px-4 py-16">
      <div class="mb-8 text-center">
        <h2 class="mb-4 text-3xl font-bold md:text-4xl">Featured Products</h2>
        <p class="text-muted-foreground">Discover our quality products</p>
      </div>
      <div class="grid grid-cols-1 gap-6 md:grid-cols-2 lg:grid-cols-3">
        {products.slice(0, 6).map((product: any) => (
          <ProductCard client:load product={product} urlFor={urlFor} locale={locale} />
        ))}
      </div>
      <div class="mt-8 text-center">
        <a
          href="/en/products"
          class="inline-flex h-10 items-center justify-center rounded-md bg-primary px-8 py-2 text-sm font-medium text-primary-foreground ring-offset-background transition-colors hover:bg-primary/90 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2"
        >
          View all products
        </a>
      </div>
    </section>
  )}

  <!-- Latest Blog Posts -->
  {recentPosts && recentPosts.length > 0 && (
    <section class="bg-muted/40 py-16">
      <div class="container mx-auto px-4">
        <div class="mb-8 text-center">
          <h2 class="mb-4 text-3xl font-bold md:text-4xl">Latest News</h2>
          <p class="text-muted-foreground">Stay updated with latest information and trends</p>
        </div>
        <div class="grid grid-cols-1 gap-6 md:grid-cols-2 lg:grid-cols-3">
          {recentPosts.map((post: any) => (
            <BlogCard client:load post={post} urlFor={urlFor} locale={locale} />
          ))}
        </div>
        <div class="mt-8 text-center">
          <a
            href="/en/blog"
            class="inline-flex h-10 items-center justify-center rounded-md bg-primary px-8 py-2 text-sm font-medium text-primary-foreground ring-offset-background transition-colors hover:bg-primary/90 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2"
          >
            View all news
          </a>
        </div>
      </div>
    </section>
  )}

  <!-- About Section -->
  <section class="container mx-auto px-4 py-16">
    <div class="mx-auto max-w-3xl text-center">
      <h2 class="mb-4 text-3xl font-bold md:text-4xl">About Us</h2>
      <p class="mb-6 text-lg text-muted-foreground">
        {siteSettings?.siteDescription || 'We provide high-quality products and services'}
      </p>
      <a
        href="/en/about"
        class="inline-flex h-10 items-center justify-center rounded-md border border-input bg-background px-8 py-2 text-sm font-medium ring-offset-background transition-colors hover:bg-accent hover:text-accent-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2"
      >
        Learn more
      </a>
    </div>
  </section>
</Layout>

